

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=&#34;auto&#34;>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/favicon.png">
  <link rel="icon" href="/img/favicon.png">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="">
  <meta name="author" content="Bsmslwx">
  <meta name="keywords" content="">
  
  <title>OneForAll代码分析-1 ~ BsmslwxBlog</title>

  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4.0.0/github-markdown.min.css" />
  <link  rel="stylesheet" href="/lib/hint/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10.7.2/styles/github-gist.min.css" />
    
  

  
    <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" />
  



<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- 自定义样式保持在最底部 -->


  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.8.11","typing":{"enable":true,"typeSpeed":80,"cursorChar":".","loop":false},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":"§"},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"copy_btn":true,"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null}},"search_path":"/local-search.xml"};
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 5.4.0"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/">&nbsp;<strong>Bsmslwx</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" data-toggle="modal" data-target="#modalSearch">&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;</a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner" id="banner" parallax=true
         style="background: url('/img/bg4.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="OneForAll代码分析-1">
              
            </span>

            
              <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2021-09-09 23:31" pubdate>
        2021年9月9日 晚上
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      6.6k 字
    </span>
  

  

  
  
</div>

            
          </div>

          
            <div class="scroll-down-bar">
              <i class="iconfont icon-arrowdown"></i>
            </div>
          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">OneForAll代码分析-1</h1>
            
              <p class="note note-info">
                
                  本文最后更新于：2021年9月11日 晚上
                
              </p>
            
            <div class="markdown-body">
              <h1 id="OneForAll代码分析-1"><a href="#OneForAll代码分析-1" class="headerlink" title="OneForAll代码分析-1"></a>OneForAll代码分析-1</h1><p>将OneForAll作为第一个分析的代码，所以在分析过程中会从最基础的开始分析，并且基本上是没有分析经历，所以可能会有很多的弯路！</p>
<h1 id="查看oneforall原作者讲解"><a href="#查看oneforall原作者讲解" class="headerlink" title="查看oneforall原作者讲解"></a>查看oneforall原作者讲解</h1><p>讲解<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/78206111">网址</a>，根据作者讲解，Oneforall的主函数是oneforall.py，所以将oneforall.py作为第一个分析的文件</p>
<p>整个目录结构</p>
<figure class="highlight elm"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs elm"><span class="hljs-type">D</span>:.<br>|<br>+<span class="hljs-comment">---.github</span><br>+<span class="hljs-comment">---docs</span><br>|       collection_modules.md 收集模块说明<br>+<span class="hljs-comment">---images</span><br>\<span class="hljs-comment">---oneforall</span><br>    |   aiobrute.py   异步多进程多协程子域爆破模块，可以单独运行<br>    |   collect.py    各个收集模块上层调用<br>    |   config.py     配置文件<br>    |   dbex<span class="hljs-keyword">port</span>.py   数据库导出模块，可以单独运行<br>    |   domains.txt   要批量爆破的域名列表<br>    |   oneforall.py  <span class="hljs-type">OneForAll</span>主入口，可以单独运行<br>    |   __init__.py<br>    |<br>    +<span class="hljs-comment">---common 公共调用模块</span><br>    +<span class="hljs-comment">---data   存放一些所需数据</span><br>    |       next_subdomains.txt     下一层子域字典<br>    |       public_suffix_list.dat  顶级域名后缀 <br>    |       srv_names.json          常见<span class="hljs-type">SRV</span>记录前缀名<br>    |       subdomains.txt          子域爆破常见字典<br>    |<br>    \<span class="hljs-comment">---modules </span><br>        +<span class="hljs-comment">---certificates     利用证书透明度收集子域模块</span><br>        +<span class="hljs-comment">---check            常规检查收集子域模块</span><br>        +<span class="hljs-comment">---crawl            利用网上爬虫档案收集子域模块</span><br>        +<span class="hljs-comment">---datasets         利用DNS数据集收集子域模块</span><br>        +<span class="hljs-comment">---dnsquery         利用DNS查询收集子域模块</span><br>        +<span class="hljs-comment">---intelligence     利用威胁情报平台数据收集子域模块</span><br>        \<span class="hljs-comment">---search           利用搜索引擎发现子域模块</span><br></code></pre></div></td></tr></table></figure>

<p>在oneforall.py中，使用了fire.Fire实现命令行界面，具体fire的使用参考<a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_17550379/article/details/79943740">网址</a></p>
<h2 id="1-init-函数"><a href="#1-init-函数" class="headerlink" title="1. __init__函数"></a>1. __init__函数</h2><p>此处只介绍oneforall.py中使用部分</p>
<figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">import</span> fire<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Tmp</span>(<span class="hljs-params"><span class="hljs-built_in">object</span></span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    Example:</span><br><span class="hljs-string">        python ./tmp.py --target example run</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self,target=<span class="hljs-literal">None</span></span>):</span><br>        self.target=target<br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">run</span>(<span class="hljs-params">self</span>):</span><br>        <span class="hljs-built_in">print</span>(self.target)<br><span class="hljs-keyword">if</span> __name__==<span class="hljs-string">&quot;__main__&quot;</span>:<br>    fire.Fire(Tmp)<br></code></pre></div></td></tr></table></figure>
<p>结果如下</p>
<blockquote>
<p>python ./tmp.py</p>
<figure class="highlight vim"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs vim">NAME<br>    tmp.<span class="hljs-keyword">py</span> - Example: <span class="hljs-keyword">python</span> ./tmp.<span class="hljs-keyword">py</span> --target example run<br><br>SYNOPSIS<br>    tmp.<span class="hljs-keyword">py</span> - COMMAND | VALUE<br><br>DESCRIPTION<br>    Example: <span class="hljs-keyword">python</span> ./tmp.<span class="hljs-keyword">py</span> --target example run<br><br>COMMANDS<br>    COMMAND <span class="hljs-keyword">is</span> one of the followin<span class="hljs-variable">g:</span><br><br>     run<br><br>VALUES   <br>    VALUE <span class="hljs-keyword">is</span> one of the followin<span class="hljs-variable">g:</span><br><br>     target<br></code></pre></div></td></tr></table></figure>

<p>python ./tmp.py –target hello run</p>
<p>hello</p>
</blockquote>
<p>对class OneForAll(object)进行分析，首先最初的字符串为命令提示内容，之后的</p>
<figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self, target=<span class="hljs-literal">None</span>, targets=<span class="hljs-literal">None</span>, brute=<span class="hljs-literal">None</span>, dns=<span class="hljs-literal">None</span>, req=<span class="hljs-literal">None</span>,port=<span class="hljs-literal">None</span>, alive=<span class="hljs-literal">None</span>, fmt=<span class="hljs-literal">None</span>, path=<span class="hljs-literal">None</span>, takeover=<span class="hljs-literal">None</span></span>):</span><br>    self.target = target<br>    self.targets = targets<br>    self.brute = brute<br>    self.dns = dns<br>    self.req = req<br>    self.port = port<br>    self.alive = alive<br>    self.fmt = fmt<br>    self.path = path<br>    self.takeover = takeover<br>    self.domain = <span class="hljs-built_in">str</span>()  <span class="hljs-comment"># 当前正在收集的域</span><br>    self.domains = <span class="hljs-built_in">set</span>()  <span class="hljs-comment"># 要收集的所有域</span><br>    self.data = <span class="hljs-built_in">list</span>()  <span class="hljs-comment"># 当前域的子域结果</span><br>    self.datas = <span class="hljs-built_in">list</span>()  <span class="hljs-comment"># 域的所有子域结果</span><br>    self.in_china = <span class="hljs-literal">None</span><br>    self.access_internet = <span class="hljs-literal">False</span><br>    self.enable_wildcard = <span class="hljs-literal">False</span><br></code></pre></div></td></tr></table></figure>

<h2 id="2-config-param函数"><a href="#2-config-param函数" class="headerlink" title="2. config_param函数"></a>2. config_param函数</h2><p>之后对于配置部分进行分析，代码如下</p>
<figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">config_param</span>(<span class="hljs-params">self</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    Config parameter</span><br><span class="hljs-string">    配置参数</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    <span class="hljs-keyword">if</span> self.brute <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>        self.brute = <span class="hljs-built_in">bool</span>(settings.enable_brute_module)<br>    <span class="hljs-keyword">if</span> self.dns <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>        self.dns = <span class="hljs-built_in">bool</span>(settings.enable_dns_resolve)<br>    <span class="hljs-keyword">if</span> self.req <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>        self.req = <span class="hljs-built_in">bool</span>(settings.enable_http_request)<br>    <span class="hljs-keyword">if</span> self.takeover <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>        self.takeover = <span class="hljs-built_in">bool</span>(settings.enable_takeover_check)<br>    <span class="hljs-keyword">if</span> self.port <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>        self.port = settings.http_request_port<br>    <span class="hljs-keyword">if</span> self.alive <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>        self.alive = <span class="hljs-built_in">bool</span>(settings.result_export_alive)<br>    <span class="hljs-keyword">if</span> self.fmt <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>        self.fmt = settings.result_save_format<br>    <span class="hljs-keyword">if</span> self.path <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>        self.path = settings.result_save_path<br></code></pre></div></td></tr></table></figure>

<p>函数中首先是判断用户是否在输入时设置了对应参数，如果没有就全部设置为默认值</p>
<p>其中self是用户输入的内容设置，而settings是默认设置源自开始的</p>
<figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-keyword">from</span> config <span class="hljs-keyword">import</span> setting<br><span class="hljs-comment"># setting设置在config目录下的__init__.py中内容如下</span><br><span class="hljs-keyword">import</span> importlib<br><span class="hljs-keyword">from</span> config <span class="hljs-keyword">import</span> default<br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Settings</span>(<span class="hljs-params"><span class="hljs-built_in">object</span></span>):</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self</span>):</span><br>        <span class="hljs-comment"># 获取全局变量中的配置信息</span><br>        <span class="hljs-comment"># dir(default)获取当前范围内的变量、方法和定义的类型列表</span><br>        <span class="hljs-keyword">for</span> attr <span class="hljs-keyword">in</span> <span class="hljs-built_in">dir</span>(default):<br>            <span class="hljs-comment"># 用于设置属性值，此处对self设置属性为attr的设置内容default中的内容</span><br>            <span class="hljs-built_in">setattr</span>(self, attr, <span class="hljs-built_in">getattr</span>(default, attr))<br>        setting_modules = [<span class="hljs-string">&#x27;config.setting&#x27;</span>, <span class="hljs-string">&#x27;config.api&#x27;</span>]<br>        <span class="hljs-keyword">for</span> setting_module <span class="hljs-keyword">in</span> setting_modules:<br>            <span class="hljs-comment"># 动态导入目录下setting，api中的内容</span><br>            setting = importlib.import_module(setting_module)<br>            <span class="hljs-keyword">for</span> attr <span class="hljs-keyword">in</span> <span class="hljs-built_in">dir</span>(setting):<br>                <span class="hljs-built_in">setattr</span>(self, attr, <span class="hljs-built_in">getattr</span>(setting, attr))<br><br><br>settings = Settings()<br></code></pre></div></td></tr></table></figure>

<p>此处主要使用的函数是<code>dir()</code>,<code>setattr(object,attribute, value)</code>,<code>getattr(object,attribute)</code>,<code>importlib.import_module()</code></p>
<p><code>dir(文件名)</code>获得当前范围内的变量、方法和定义的类型列表</p>
<p><code>setattr(object,attribute, value)</code>对object中的attribute设置为value</p>
<p><code>getattr(object,attribute)</code>取出object中的attribute中的值</p>
<p><code>importlib.import_module(文件)</code>导入文件中的对象</p>
<p>示例</p>
<figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-comment"># config目录下</span><br><span class="hljs-comment"># 1.__init__.py文件</span><br><span class="hljs-keyword">import</span> importlib<br><span class="hljs-keyword">from</span> config <span class="hljs-keyword">import</span> default<br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Settings</span>(<span class="hljs-params"><span class="hljs-built_in">object</span></span>):</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self</span>):</span><br>        <span class="hljs-comment"># 获取全局变量中的配置信息</span><br>        <span class="hljs-built_in">print</span>(<span class="hljs-built_in">dir</span>(default))<br>        <span class="hljs-keyword">for</span> attr <span class="hljs-keyword">in</span> <span class="hljs-built_in">dir</span>(default):<br>            <span class="hljs-built_in">setattr</span>(self, attr, <span class="hljs-built_in">getattr</span>(default, attr))<br>        setting_modules = [<span class="hljs-string">&#x27;config.a&#x27;</span>]<br>        <span class="hljs-keyword">for</span> setting_module <span class="hljs-keyword">in</span> setting_modules:<br>            setting = importlib.import_module(setting_module)<br>            <span class="hljs-keyword">for</span> attr <span class="hljs-keyword">in</span> <span class="hljs-built_in">dir</span>(setting):<br>                <span class="hljs-built_in">setattr</span>(self, attr, <span class="hljs-built_in">getattr</span>(setting, attr))<br><br><br>settings = Settings()<br><span class="hljs-comment"># 2. default.py 文件</span><br><span class="hljs-keyword">import</span> pathlib<br><span class="hljs-comment">## 获取当前路径位置,返回两次上级目录</span><br>now_dir=pathlib.Path(__file__).parent.parent<br><span class="hljs-comment">## 设置根目录下具体需要的目录</span><br>module_dir=now_dir.joinpath(<span class="hljs-string">&#x27;modules&#x27;</span>)<br><span class="hljs-comment">## 设置内容以备读取</span><br>lwx=<span class="hljs-string">&#x27;hello&#x27;</span><br><span class="hljs-comment"># 3. a.py 文件</span><br>bsms=<span class="hljs-string">&#x27;world&#x27;</span><br><span class="hljs-comment"># 同config文件夹下 tmp.py 文件</span><br><span class="hljs-keyword">import</span> fire<br><span class="hljs-keyword">from</span> one <span class="hljs-keyword">import</span> ou<br><span class="hljs-keyword">from</span> config <span class="hljs-keyword">import</span> settings<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Tmp</span>(<span class="hljs-params"><span class="hljs-built_in">object</span></span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    Example:</span><br><span class="hljs-string">        python ./tmp.py --target example run</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self,target=<span class="hljs-literal">None</span></span>):</span><br>        self.target=target<br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">run</span>(<span class="hljs-params">self</span>):</span><br>        <span class="hljs-built_in">print</span>(self.target)<br><span class="hljs-keyword">if</span> __name__==<span class="hljs-string">&quot;__main__&quot;</span>:<br>    fire.Fire(Tmp)<br>    <span class="hljs-built_in">print</span>(settings.lwx+settings.bsms)<br>    <span class="hljs-built_in">print</span>(settings.module_dir)<br></code></pre></div></td></tr></table></figure>

<p>结果如下</p>
<blockquote>
<p>python ./tmp.py –target one run</p>
<p>one</p>
<p>helloworld</p>
<p>具体路径(C:\**\oneforall\modules)</p>
</blockquote>
<h2 id="3-check-param函数"><a href="#3-check-param函数" class="headerlink" title="3. check_param函数"></a>3. check_param函数</h2><p>现在对参数进行检查的部分代码如下</p>
<figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">check_param</span>(<span class="hljs-params">self</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    检查参数</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    <span class="hljs-keyword">if</span> self.target <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">and</span> self.targets <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:<br>        logger.log(<span class="hljs-string">&#x27;FATAL&#x27;</span>, <span class="hljs-string">&#x27;You must provide either target or targets parameter&#x27;</span>)<br>        exit(<span class="hljs-number">1</span>)<br></code></pre></div></td></tr></table></figure>

<p>此处只是对目标(target)进行检查，如果不存在目标或目标列就记录且程序异常退出程序<code>exit(1)</code></p>
<h2 id="4-export-data函数"><a href="#4-export-data函数" class="headerlink" title="4. export_data函数"></a>4. export_data函数</h2><p>该部分是表示返回的数据内容</p>
<figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">export_data</span>(<span class="hljs-params">self</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    Export data from the database</span><br><span class="hljs-string"></span><br><span class="hljs-string">    :return: exported data</span><br><span class="hljs-string">    :rtype: list</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    <span class="hljs-keyword">return</span> export.export_data(self.domain, alive=self.alive, fmt=self.fmt, path=self.path)<br><br></code></pre></div></td></tr></table></figure>

<h2 id="5-run函数"><a href="#5-run函数" class="headerlink" title="5. run函数"></a>5. run函数</h2><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">run</span>(<span class="hljs-params">self</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    OneForAll running entrance</span><br><span class="hljs-string"></span><br><span class="hljs-string">    :return: All subdomain results</span><br><span class="hljs-string">    :rtype: list</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    <span class="hljs-built_in">print</span>(oneforall_banner)<br>    dt = datetime.now().strftime(<span class="hljs-string">&#x27;%Y-%m-%d %H:%M:%S&#x27;</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;[*] Starting OneForAll @ <span class="hljs-subst">&#123;dt&#125;</span>\n&#x27;</span>)<br>    logger.log(<span class="hljs-string">&#x27;DEBUG&#x27;</span>, <span class="hljs-string">&#x27;Python &#x27;</span> + utils.python_version())<br>    logger.log(<span class="hljs-string">&#x27;DEBUG&#x27;</span>, <span class="hljs-string">&#x27;OneForAll &#x27;</span> + version)<br>    utils.check_dep()<br>    self.access_internet, self.in_china = utils.get_net_env()<br>    <span class="hljs-keyword">if</span> self.access_internet <span class="hljs-keyword">and</span> settings.enable_check_version:<br>        utils.check_version(version)<br>    logger.log(<span class="hljs-string">&#x27;INFOR&#x27;</span>, <span class="hljs-string">&#x27;Start running OneForAll&#x27;</span>)<br>    self.config_param()<br>    self.check_param()<br>    self.domains = utils.get_domains(self.target, self.targets)<br>    count = <span class="hljs-built_in">len</span>(self.domains)<br>    logger.log(<span class="hljs-string">&#x27;INFOR&#x27;</span>, <span class="hljs-string">f&#x27;Got <span class="hljs-subst">&#123;count&#125;</span> domains&#x27;</span>)<br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> count:<br>        logger.log(<span class="hljs-string">&#x27;FATAL&#x27;</span>, <span class="hljs-string">&#x27;Failed to obtain domain&#x27;</span>)<br>        exit(<span class="hljs-number">1</span>)<br>    <span class="hljs-keyword">for</span> domain <span class="hljs-keyword">in</span> self.domains:<br>        self.domain = utils.get_main_domain(domain)<br>        self.main()<br>    <span class="hljs-keyword">if</span> count &gt; <span class="hljs-number">1</span>:<br>        utils.export_all(self.alive, self.fmt, self.path, self.datas)<br>    logger.log(<span class="hljs-string">&#x27;INFOR&#x27;</span>, <span class="hljs-string">&#x27;Finished OneForAll&#x27;</span>)<br></code></pre></div></td></tr></table></figure>

<p>对代码进行简单的逐步分析</p>
<h3 id="5-1-check-dep函数"><a href="#5-1-check-dep函数" class="headerlink" title="5.1 check_dep函数"></a>5.1 check_dep函数</h3><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-comment"># 代码中前面部分是基本信息的输出</span><br><span class="hljs-comment"># 从正式的部分开始分析</span><br><span class="hljs-comment"># 其中utils是从目录common中导入的</span><br>utils.check_dep() <span class="hljs-comment"># 跟进函数check_dep()</span><br><span class="hljs-comment"># check_dep()</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">check_dep</span>():</span><br>    logger.log(<span class="hljs-string">&#x27;INFOR&#x27;</span>, <span class="hljs-string">&#x27;Checking dependent environment&#x27;</span>)<br>    <span class="hljs-comment"># 返回使用的python解释器</span><br>    implementation = platform.python_implementation()<br>    <span class="hljs-comment"># 返回使用的python版本号</span><br>    version = platform.python_version()<br>    <span class="hljs-comment"># 对返回的内容进行判断，是否满足需求</span><br>    <span class="hljs-comment"># python解释器是否为CPython</span><br>    <span class="hljs-keyword">if</span> implementation != <span class="hljs-string">&#x27;CPython&#x27;</span>:<br>        logger.log(<span class="hljs-string">&#x27;FATAL&#x27;</span>, <span class="hljs-string">f&#x27;OneForAll only passed the test under CPython&#x27;</span>)<br>        exit(<span class="hljs-number">1</span>)<br>    <span class="hljs-comment"># Python版本是否大于3.6</span><br>    <span class="hljs-keyword">if</span> LooseVersion(version) &lt; LooseVersion(<span class="hljs-string">&#x27;3.6&#x27;</span>):<br>        logger.log(<span class="hljs-string">&#x27;FATAL&#x27;</span>, <span class="hljs-string">&#x27;OneForAll requires Python 3.6 or higher&#x27;</span>)<br>        exit(<span class="hljs-number">1</span>)<br></code></pre></div></td></tr></table></figure>

<h3 id="5-2-get-net-env函数"><a href="#5-2-get-net-env函数" class="headerlink" title="5.2 get_net_env函数"></a>5.2 get_net_env函数</h3><p>进一步对下一行代码进行分析</p>
<figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-comment"># run()</span><br>self.access_internet, self.in_china = utils.get_net_env() <span class="hljs-comment"># 简单得出会返回两个值，分别为是否成功连接网络，是否在中国</span><br><span class="hljs-comment"># def get_net_env()</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_net_env</span>():</span><br>    logger.log(<span class="hljs-string">&#x27;INFOR&#x27;</span>, <span class="hljs-string">&#x27;Checking network environment&#x27;</span>)<br>    <span class="hljs-keyword">try</span>:<br>        <span class="hljs-comment"># 使用具体的检查网络的函数</span><br>        result = check_net()<br>    <span class="hljs-comment"># 对无法联网之后的进行记录，输出</span><br>    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>        logger.log(<span class="hljs-string">&#x27;DEBUG&#x27;</span>, e.args)<br>        logger.log(<span class="hljs-string">&#x27;ALERT&#x27;</span>, <span class="hljs-string">&#x27;Please check your network environment.&#x27;</span>)<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>, <span class="hljs-literal">None</span><br>    <span class="hljs-keyword">return</span> result<br><span class="hljs-comment"># def check_net()</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">check_net</span>():</span><br>    <span class="hljs-comment"># 如下网站本身是获取用户具体地址等信息的但是国内无法访问？？？？</span><br>    urls = [<span class="hljs-string">&#x27;http://ipinfo.io/json&#x27;</span>, <span class="hljs-string">&#x27;http://ipconfig.io/json&#x27;</span>]<br>    <span class="hljs-comment"># 随机选择一个url地址</span><br>    url = random.choice(urls)<br>    <span class="hljs-comment"># 设置请求的参数等等</span><br>    header = &#123;<span class="hljs-string">&#x27;User_Agent&#x27;</span>: <span class="hljs-string">&#x27;curl&#x27;</span>&#125;<br>    timeout = settings.request_timeout_second<br>    <span class="hljs-comment"># verify表示的是：是否请求SSL验证(默认False)</span><br>    verify = settings.request_ssl_verify<br>    logger.log(<span class="hljs-string">&#x27;DEBUG&#x27;</span>, <span class="hljs-string">f&#x27;Trying to access <span class="hljs-subst">&#123;url&#125;</span>&#x27;</span>)<br>    <span class="hljs-comment"># requests.Session()表示会话保持，即使用session成功的登录了某个网站，则在再次使用该session对象求求该网站的其他网页都会默认使用该session之前使用的cookie等参数</span><br>    session = requests.Session()<br>    <span class="hljs-comment"># 经过查询应该是不适用代理的意思</span><br>    session.trust_env = <span class="hljs-literal">False</span><br>    <span class="hljs-keyword">try</span>:<br>        rsp = session.get(url, headers=header, timeout=timeout, verify=verify)<br>    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>        logger.log(<span class="hljs-string">&#x27;ERROR&#x27;</span>, e.args)<br>        logger.log(<span class="hljs-string">&#x27;ALERT&#x27;</span>, <span class="hljs-string">&#x27;Unable to access Internet, retrying...&#x27;</span>)<br>        <span class="hljs-keyword">raise</span> e<br>    logger.log(<span class="hljs-string">&#x27;DEBUG&#x27;</span>, <span class="hljs-string">&#x27;Access to Internet OK&#x27;</span>)<br>    country = rsp.json().get(<span class="hljs-string">&#x27;country&#x27;</span>).lower()<br>    <span class="hljs-comment"># 此处应该是判断是否在中国的程序，但是由于目标两个网站无法被墙，注定无法在中国了。。。。</span><br>    <span class="hljs-keyword">if</span> country <span class="hljs-keyword">in</span> [<span class="hljs-string">&#x27;cn&#x27;</span>, <span class="hljs-string">&#x27;china&#x27;</span>]:<br>        logger.log(<span class="hljs-string">&#x27;DEBUG&#x27;</span>, <span class="hljs-string">f&#x27;The computer is located in China&#x27;</span>)<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span>, <span class="hljs-literal">True</span><br>    <span class="hljs-keyword">else</span>:<br>        logger.log(<span class="hljs-string">&#x27;DEBUG&#x27;</span>, <span class="hljs-string">f&#x27;The computer is not located in China&#x27;</span>)<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span>, <span class="hljs-literal">False</span><br></code></pre></div></td></tr></table></figure>

<p>经过实际测试，<code>http://ipconfig.io/json</code>偶尔能够访问，所以可以将地址替换为类似功能的地址<code>https://ifconfig.co/json</code>将原本的两个删除</p>
<h3 id="5-3-check-version函数"><a href="#5-3-check-version函数" class="headerlink" title="5.3 check_version函数"></a>5.3 check_version函数</h3><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-comment"># run</span><br><span class="hljs-comment"># 此处是对于oneforall本身版本的检测 设置为联网时检测</span><br><span class="hljs-keyword">if</span> self.access_internet <span class="hljs-keyword">and</span> settings.enable_check_version:<br>    <span class="hljs-comment"># 检测oneforall的版本是否是最新版本</span><br>    utils.check_version(version)<br><span class="hljs-comment"># def check_version函数</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">check_version</span>(<span class="hljs-params">local</span>):</span><br>    logger.log(<span class="hljs-string">&#x27;INFOR&#x27;</span>, <span class="hljs-string">&#x27;Checking for the latest version&#x27;</span>)<br>    <span class="hljs-comment"># 需要访问的接口地址</span><br>    api = <span class="hljs-string">&#x27;https://api.github.com/repos/shmilylty/OneForAll/releases/latest&#x27;</span><br>    <span class="hljs-comment"># 此处是设置具体的请求头，基本同check_net中的设置</span><br>    <span class="hljs-comment"># 之后跟进对应get_random_header，get_proxy函数的具体生成</span><br>    header = get_random_header()<br>    proxy = get_proxy()<br>    timeout = settings.request_timeout_second<br>    verify = settings.request_ssl_verify<br>    session = requests.Session()<br>    session.trust_env = <span class="hljs-literal">False</span><br>    <span class="hljs-keyword">try</span>:<br>        <span class="hljs-comment"># 获取具体内容</span><br>        resp = session.get(url=api, headers=header, proxies=proxy,<br>                           timeout=timeout, verify=verify)<br>        <span class="hljs-comment"># 转变为json格式，并提取最晚的版本</span><br>        resp_json = resp.json()<br>        latest = resp_json[<span class="hljs-string">&#x27;tag_name&#x27;</span>]<br>    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>        logger.log(<span class="hljs-string">&#x27;ALERT&#x27;</span>, <span class="hljs-string">&#x27;An error occurred while checking the latest version&#x27;</span>)<br>        logger.log(<span class="hljs-string">&#x27;DEBUG&#x27;</span>, e.args)<br>        <span class="hljs-keyword">return</span><br>    <span class="hljs-comment"># 对获取的版本与本身的版本进行比较，并输出内容</span><br>    <span class="hljs-keyword">if</span> latest &gt; local:<br>        change = resp_json.get(<span class="hljs-string">&quot;body&quot;</span>)<br>        logger.log(<span class="hljs-string">&#x27;ALERT&#x27;</span>, <span class="hljs-string">f&#x27;The current version is <span class="hljs-subst">&#123;local&#125;</span> &#x27;</span><br>                            <span class="hljs-string">f&#x27;but the latest version is <span class="hljs-subst">&#123;latest&#125;</span>&#x27;</span>)<br>        logger.log(<span class="hljs-string">&#x27;ALERT&#x27;</span>, <span class="hljs-string">f&#x27;The <span class="hljs-subst">&#123;latest&#125;</span> version mainly has the following changes&#x27;</span>)<br>        logger.log(<span class="hljs-string">&#x27;ALERT&#x27;</span>, change)<br>    <span class="hljs-keyword">else</span>:<br>        logger.log(<span class="hljs-string">&#x27;INFOR&#x27;</span>, <span class="hljs-string">f&#x27;The current version <span class="hljs-subst">&#123;local&#125;</span> is already the latest version&#x27;</span>)<br></code></pre></div></td></tr></table></figure>

<h4 id="5-3-1-get-random-header函数"><a href="#5-3-1-get-random-header函数" class="headerlink" title="5.3.1 get_random_header函数"></a>5.3.1 get_random_header函数</h4><p>在上一个模块中遇到的内容进一步跟进解读</p>
<figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-comment"># def get_random_header</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_random_header</span>():</span><br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    等等随机的header</span><br><span class="hljs-string">    Get random header</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    headers = gen_fake_header()<br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-built_in">isinstance</span>(headers, <span class="hljs-built_in">dict</span>):<br>        headers = <span class="hljs-literal">None</span><br>    <span class="hljs-keyword">return</span> headers<br><span class="hljs-comment"># 进一步跟进函数gen_fake_header()</span><br><span class="hljs-comment"># def gen_fake_header</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">gen_fake_header</span>():</span><br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    Generate fake request headers</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    <span class="hljs-comment"># 首先将headers赋值为默认的header</span><br>    headers = settings.request_default_headers<br>    <span class="hljs-comment"># 判断headers是否不是dict类型</span><br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-built_in">isinstance</span>(headers, <span class="hljs-built_in">dict</span>):<br>        headers = <span class="hljs-built_in">dict</span>()<br>    <span class="hljs-comment"># 判断是否设置了随机ua</span><br>    <span class="hljs-keyword">if</span> settings.enable_random_ua:<br>        <span class="hljs-comment"># 随机选择ua并赋值给headers</span><br>        ua = random.choice(user_agents)<br>        headers[<span class="hljs-string">&#x27;User-Agent&#x27;</span>] = ua<br>    headers[<span class="hljs-string">&#x27;Accept-Encoding&#x27;</span>] = <span class="hljs-string">&#x27;gzip, deflate&#x27;</span><br>    <span class="hljs-keyword">return</span> headers<br></code></pre></div></td></tr></table></figure>



<h4 id="5-3-2-get-proxy函数"><a href="#5-3-2-get-proxy函数" class="headerlink" title="5.3.2 get_proxy函数"></a>5.3.2 get_proxy函数</h4><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-comment"># def get_proxy</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_proxy</span>():</span><br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    Get proxy</span><br><span class="hljs-string">    得到proxy</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    <span class="hljs-comment"># 判断是否 需要proxy 默认不需要</span><br>    <span class="hljs-keyword">if</span> settings.enable_request_proxy:<br>        <span class="hljs-keyword">return</span> get_random_proxy()<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span><br><span class="hljs-comment"># def get_random_proxy</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_random_proxy</span>():</span><br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    Get random proxy</span><br><span class="hljs-string">    得到随机proxy</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    <span class="hljs-keyword">try</span>:<br>        <span class="hljs-comment"># 获取用户自己定义的proxy_pool中的一个</span><br>        <span class="hljs-keyword">return</span> random.choice(settings.request_proxy_pool)<br>    <span class="hljs-keyword">except</span> IndexError:<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span><br></code></pre></div></td></tr></table></figure>

<h3 id="5-4-获取并检测自身的配置参数"><a href="#5-4-获取并检测自身的配置参数" class="headerlink" title="5.4 获取并检测自身的配置参数"></a>5.4 获取并检测自身的配置参数</h3><p>即之后紧跟的self.config_param和self.check_param函数分析。该部分在之前的2，3节进行了分析</p>
<h3 id="5-5-get-domains函数"><a href="#5-5-get-domains函数" class="headerlink" title="5.5 get_domains函数"></a>5.5 get_domains函数</h3><p>之后应该是<del>重头戏</del>的获取域名(只是返回规范的域名)了对对应的函数进行分析</p>
<figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-comment"># def get_domains()</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_domains</span>(<span class="hljs-params">target, targets=<span class="hljs-literal">None</span></span>):</span><br>    logger.log(<span class="hljs-string">&#x27;DEBUG&#x27;</span>, <span class="hljs-string">f&#x27;Getting domains&#x27;</span>)<br>    <span class="hljs-comment"># 对单个域名进行域名的正确返回</span><br>    target_domains = get_from_target(target)<br>    <span class="hljs-comment"># 对多个域名进行域名的正确返回</span><br>    targets_domains = get_from_targets(targets)<br>    <span class="hljs-comment"># 将多个内容进行整合</span><br>    domains = <span class="hljs-built_in">list</span>(target_domains.union(targets_domains))<br>    <span class="hljs-comment"># 如果存在多个域名的规范域名则按照targets进行排序</span><br>    <span class="hljs-keyword">if</span> targets_domains:<br>        domains = <span class="hljs-built_in">sorted</span>(domains, key=targets_domains.index)  <span class="hljs-comment"># 按照targets原本的index排序</span><br>    <span class="hljs-comment"># 如果没有得到规范的域名则报错</span><br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> domains:<br>        logger.log(<span class="hljs-string">&#x27;ERROR&#x27;</span>, <span class="hljs-string">f&#x27;Did not get a valid domain name&#x27;</span>)<br>    logger.log(<span class="hljs-string">&#x27;DEBUG&#x27;</span>, <span class="hljs-string">f&#x27;The obtained domains \n<span class="hljs-subst">&#123;domains&#125;</span>&#x27;</span>)<br>    <span class="hljs-keyword">return</span> domains<br></code></pre></div></td></tr></table></figure>

<h4 id="5-5-1-get-from-target函数"><a href="#5-5-1-get-from-target函数" class="headerlink" title="5.5.1 get_from_target函数"></a>5.5.1 get_from_target函数</h4><p>进一步跟进函数了解具体如何获取单个域名的子域名</p>
<figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-comment"># def get_from_target</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_from_target</span>(<span class="hljs-params">target</span>):</span><br>    <span class="hljs-comment"># 将domains设置为元素集</span><br>    <span class="hljs-comment"># set(): 函数创建一个无序不重复元素集，可进行关系测试，删除重复数据，还可以计算交集、差集、并集等</span><br>    domains = <span class="hljs-built_in">set</span>()<br>    <span class="hljs-comment"># 基本的判断输入的target不是targets的内容</span><br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(target, <span class="hljs-built_in">str</span>):<br>        <span class="hljs-keyword">if</span> target.endswith(<span class="hljs-string">&#x27;.txt&#x27;</span>):<br>            logger.log(<span class="hljs-string">&#x27;FATAL&#x27;</span>, <span class="hljs-string">&#x27;Use targets parameter for multiple domain names&#x27;</span>)<br>            exit(<span class="hljs-number">1</span>)<br>        <span class="hljs-comment"># 获取正确的域名，如输入的是www.baidu.com此处返回www.baidu.com</span><br>        domain = match_main_domain(target)<br>        <span class="hljs-comment"># 如果domain不存在返回</span><br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> domain:<br>            <span class="hljs-keyword">return</span> domains<br>        <span class="hljs-comment"># 添加内容到domains中</span><br>        domains.add(domain)<br>    <span class="hljs-keyword">return</span> domains<br></code></pre></div></td></tr></table></figure>

<p>此处继续跟进函数match_main_dimain</p>
<figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-comment"># def match_main_dimain</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">match_main_domain</span>(<span class="hljs-params">domain</span>):</span><br>    <span class="hljs-comment"># 判断domain类型是否不是str</span><br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-built_in">isinstance</span>(domain, <span class="hljs-built_in">str</span>):<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span><br>    <span class="hljs-comment"># 将用户输入的target进行小写处理和去除空格</span><br>    item = domain.lower().strip()<br>    <span class="hljs-comment"># 此处是作者自己的写的代码，需要进一步进行分析 代码是分析是否是域格式</span><br>    <span class="hljs-keyword">return</span> Domain(item).match()<br></code></pre></div></td></tr></table></figure>

<h5 id="5-5-1-1-Domain-item-match"><a href="#5-5-1-1-Domain-item-match" class="headerlink" title="5.5.1.1 Domain(item).match"></a>5.5.1.1 Domain(item).match</h5><p>对Domain.match进行分析</p>
<figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-comment"># class Domain</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Domain</span>(<span class="hljs-params"><span class="hljs-built_in">object</span></span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    处理域类</span><br><span class="hljs-string">    Processing domain class</span><br><span class="hljs-string"></span><br><span class="hljs-string">    :param str string: input string</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self, string</span>):</span><br>        self.string = <span class="hljs-built_in">str</span>(string)<br>        <span class="hljs-comment"># 正则代码分析 \b匹配一个单词边界 ?=正向预查模式(在任何开始匹配圆括号内的正则表达式模式的位置来匹配搜索字符串)(即在满足后面的情况下查找前面的内容) (xn--)(表示国际域名的格式) ?表示非贪婪模式 之后的-号不清楚意义</span><br>        self.regexp = <span class="hljs-string">r&#x27;\b((?=[a-z0-9-]&#123;1,63&#125;\.)(xn--)?[a-z0-9]+(-[a-z0-9]+)*\.)+[a-z]&#123;2,63&#125;\b&#x27;</span><br>        self.domain = <span class="hljs-literal">None</span><br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">match</span>(<span class="hljs-params">self</span>):</span><br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        match domain</span><br><span class="hljs-string">        匹配域</span><br><span class="hljs-string">        :return : result</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <span class="hljs-comment"># 返回具体的域名</span><br>        result = re.search(self.regexp, self.string, re.I)<br>        <span class="hljs-keyword">if</span> result:<br>            <span class="hljs-keyword">return</span> result.group()<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span><br></code></pre></div></td></tr></table></figure>

<h4 id="5-5-2-get-from-targets函数"><a href="#5-5-2-get-from-targets函数" class="headerlink" title="5.5.2 get_from_targets函数"></a>5.5.2 get_from_targets函数</h4><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-comment"># def get_from_targets</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_from_targets</span>(<span class="hljs-params">targets</span>):</span><br>    domains = <span class="hljs-built_in">set</span>()<br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-built_in">isinstance</span>(targets, <span class="hljs-built_in">str</span>):<br>        <span class="hljs-keyword">return</span> domains<br>    <span class="hljs-keyword">try</span>:<br>        <span class="hljs-comment"># 获取文件的名称</span><br>        path = Path(targets)<br>    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>        logger.log(<span class="hljs-string">&#x27;ERROR&#x27;</span>, e.args)<br>        <span class="hljs-keyword">return</span> domains<br>    <span class="hljs-comment"># 判断文件是否存在，且是否是文件</span><br>    <span class="hljs-keyword">if</span> path.exists() <span class="hljs-keyword">and</span> path.is_file():<br>        <span class="hljs-comment"># 读取文件内容 相关函数较为简单之后跟进</span><br>        domains = read_target_file(targets)<br>        <span class="hljs-keyword">return</span> domains<br>    <span class="hljs-keyword">return</span> domains<br><br><span class="hljs-comment"># read_target_file</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">read_target_file</span>(<span class="hljs-params">target</span>):</span><br>    domains = <span class="hljs-built_in">list</span>()<br>    <span class="hljs-comment"># 打开文件</span><br>    <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(target, encoding=<span class="hljs-string">&#x27;utf-8&#x27;</span>, errors=<span class="hljs-string">&#x27;ignore&#x27;</span>) <span class="hljs-keyword">as</span> file:<br>        <span class="hljs-comment"># 逐行读取存储</span><br>        <span class="hljs-keyword">for</span> line <span class="hljs-keyword">in</span> file:<br>            <span class="hljs-comment"># 判断是否符合域名规则并返回标准域名格式</span><br>            domain = match_main_domain(line)<br>            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> domain:<br>                <span class="hljs-keyword">continue</span><br>            domains.append(domain)<br>    <span class="hljs-comment"># 对域名进行排序后返回内容</span><br>    sorted_domains = <span class="hljs-built_in">sorted</span>(<span class="hljs-built_in">set</span>(domains), key=domains.index)<br>    <span class="hljs-keyword">return</span> sorted_domains<br><br><span class="hljs-comment"># match_main_domain</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">match_main_domain</span>(<span class="hljs-params">domain</span>):</span><br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-built_in">isinstance</span>(domain, <span class="hljs-built_in">str</span>):<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span><br>    item = domain.lower().strip()<br>    <span class="hljs-keyword">return</span> Domain(item).match()<br></code></pre></div></td></tr></table></figure>

<h3 id="5-6-get-main-domain函数"><a href="#5-6-get-main-domain函数" class="headerlink" title="5.6 get_main_domain函数"></a>5.6 get_main_domain函数</h3><p>之后的代码较为简单，这里写上但是重点分析get_main_domain函数</p>
<figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-comment"># run</span><br><span class="hljs-comment"># 需要进行搜索的域名个数</span><br>count = <span class="hljs-built_in">len</span>(self.domains)<br>logger.log(<span class="hljs-string">&#x27;INFOR&#x27;</span>, <span class="hljs-string">f&#x27;Got <span class="hljs-subst">&#123;count&#125;</span> domains&#x27;</span>)<br><span class="hljs-comment"># 当域名个数为零时结束函数</span><br><span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> count:<br>    logger.log(<span class="hljs-string">&#x27;FATAL&#x27;</span>, <span class="hljs-string">&#x27;Failed to obtain domain&#x27;</span>)<br>    exit(<span class="hljs-number">1</span>)<br><span class="hljs-comment"># 对需要搜索的域名进行子域名搜索</span><br><span class="hljs-keyword">for</span> domain <span class="hljs-keyword">in</span> self.domains:<br>    <span class="hljs-comment"># 先跟进函数后解释 </span><br>    self.domain = utils.get_main_domain(domain)<br>    <span class="hljs-comment"># 切换到main函数</span><br>    self.main()<br><span class="hljs-comment"># def get_main_domain</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_main_domain</span>(<span class="hljs-params">domain</span>):</span><br>    <span class="hljs-comment"># 判断域名是否是字符串</span><br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-built_in">isinstance</span>(domain, <span class="hljs-built_in">str</span>):<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span><br>    <span class="hljs-comment"># 之后进一步跟进函数</span><br>    <span class="hljs-keyword">return</span> Domain(domain).registered()<br></code></pre></div></td></tr></table></figure>

<p>对于Domain(domain).registered进行分析</p>
<figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-comment"># def registered</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">registered</span>(<span class="hljs-params">self</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    注册域</span><br><span class="hljs-string">    registered domain</span><br><span class="hljs-string"></span><br><span class="hljs-string">    &gt;&gt;&gt; d = Domain(&#x27;www.example.com&#x27;)</span><br><span class="hljs-string">    &lt;domain.Domain object&gt;</span><br><span class="hljs-string">    &gt;&gt;&gt; d.registered()</span><br><span class="hljs-string">    example.com</span><br><span class="hljs-string"></span><br><span class="hljs-string">    :return: registered domain result</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    <span class="hljs-comment"># 进一步分析 extract函数</span><br>    result = self.extract()<br>    <span class="hljs-keyword">if</span> result:<br>        <span class="hljs-keyword">return</span> result.registered_domain<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span><br><br><span class="hljs-comment"># def extract</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">extract</span>(<span class="hljs-params">self</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    提取域</span><br><span class="hljs-string">    extract domain</span><br><span class="hljs-string"></span><br><span class="hljs-string">    &gt;&gt;&gt; d = Domain(&#x27;www.example.com&#x27;)</span><br><span class="hljs-string">    &lt;domain.Domain object&gt;</span><br><span class="hljs-string">    &gt;&gt;&gt; d.extract()</span><br><span class="hljs-string">    ExtractResult(subdomain=&#x27;www&#x27;, domain=&#x27;example&#x27;, suffix=&#x27;com&#x27;)</span><br><span class="hljs-string"></span><br><span class="hljs-string">    :return: extracted domain results</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    <span class="hljs-comment"># 设置路径</span><br>    data_storage_dir = settings.data_storage_dir<br>    <span class="hljs-comment"># 选择data目录下的public_suffix_list.dat表</span><br>    extract_cache_file = data_storage_dir.joinpath(<span class="hljs-string">&#x27;public_suffix_list.dat&#x27;</span>)<br>    <span class="hljs-comment"># 跟进分析 此处只是调用了__init__部分将可能存在的~转变为正常路径</span><br>    ext = tldextract.TLDExtract(extract_cache_file)<br>    <span class="hljs-comment"># 跟进分析 正则匹配后将输出有效的域名</span><br>    result = self.match()<br>    <span class="hljs-keyword">if</span> result:<br>        <span class="hljs-comment"># 跟进分析 </span><br>        <span class="hljs-keyword">return</span> ext(result)<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span><br><br><span class="hljs-comment"># class TLDExtract</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TLDExtract</span>(<span class="hljs-params"><span class="hljs-built_in">object</span></span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    A callable for extracting, subdomain, domain, and suffix components from a URL.</span><br><span class="hljs-string">    用于从URL提取、子域、域和后缀组件的可调用函数</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span>(<span class="hljs-params">self, cache_file=<span class="hljs-literal">None</span></span>):</span><br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        Constructs a callable for extracting subdomain, domain, and suffix</span><br><span class="hljs-string">        components from a URL.</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <span class="hljs-comment"># os.path.expanduser将传入路径为~替换为详细的路径如~/tmp为/home/user/tmp(windows中为 c:\Users\user\tmp)</span><br>        self.cache_file = os.path.expanduser(cache_file <span class="hljs-keyword">or</span> <span class="hljs-string">&#x27;&#x27;</span>)<br>        self._extractor = <span class="hljs-literal">None</span><br>    <span class="hljs-comment"># __call__实际上是将一个类重载了&quot;()&quot;，也就是让一个类也可以像一个函数一样可以拿来调用了,在此处下一个ext(result)调用</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__call__</span>(<span class="hljs-params">self, url</span>):</span><br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        Takes a string URL and splits it into its subdomain, domain, and</span><br><span class="hljs-string">        suffix (effective TLD, gTLD, ccTLD, etc.) component.</span><br><span class="hljs-string">        获取字符串URL并将其拆分为子域、域和后缀（有效TLD、gTLD、ccTLD等）组件。</span><br><span class="hljs-string">        &gt;&gt;&gt; ext = TLDExtract()</span><br><span class="hljs-string">        &gt;&gt;&gt; ext(&#x27;http://forums.news.cnn.com/&#x27;)</span><br><span class="hljs-string">        ExtractResult(subdomain=&#x27;forums.news&#x27;, domain=&#x27;cnn&#x27;, suffix=&#x27;com&#x27;)</span><br><span class="hljs-string">        &gt;&gt;&gt; ext(&#x27;http://forums.bbc.co.uk/&#x27;)</span><br><span class="hljs-string">        ExtractResult(subdomain=&#x27;forums&#x27;, domain=&#x27;bbc&#x27;, suffix=&#x27;co.uk&#x27;)</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <span class="hljs-comment"># 匹配scheme_chars开头的内容以://结尾的</span><br>        <span class="hljs-comment"># 注：SCHEME_RE = re.compile(r&#x27;^([&#x27; + scheme_chars + &#x27;]+:)?//&#x27;)</span><br>        <span class="hljs-comment"># scheme_chars = (&#x27;abcdefghijklmnopqrstuvwxyz&#x27;&#x27;ABCDEFGHIJKLMNOPQRSTUVWXYZ&#x27;&#x27;0123456789&#x27;&#x27;+-.&#x27;)</span><br>        <span class="hljs-comment"># 首先去除://或://开头的内容 提取第一个/前的部分 提取第一个?前的内容 提取第一个#前的内容 提取@分割后的最后一个 提取第一个:前的部分 去除前.后空格</span><br>        netloc = SCHEME_RE.sub(<span class="hljs-string">&quot;&quot;</span>, url) \<br>            .partition(<span class="hljs-string">&quot;/&quot;</span>)[<span class="hljs-number">0</span>] \<br>            .partition(<span class="hljs-string">&quot;?&quot;</span>)[<span class="hljs-number">0</span>] \<br>            .partition(<span class="hljs-string">&quot;#&quot;</span>)[<span class="hljs-number">0</span>] \<br>            .split(<span class="hljs-string">&quot;@&quot;</span>)[-<span class="hljs-number">1</span>] \<br>            .partition(<span class="hljs-string">&quot;:&quot;</span>)[<span class="hljs-number">0</span>] \<br>            .strip() \<br>            .rstrip(<span class="hljs-string">&quot;.&quot;</span>)<br>        <span class="hljs-comment"># 按照.对域名进行分割</span><br>        labels = netloc.split(<span class="hljs-string">&quot;.&quot;</span>)<br>        <span class="hljs-comment"># 跟进源码分析 将分割后的域名逐个添加到translations中</span><br>        translations = [_decode_punycode(label) <span class="hljs-keyword">for</span> label <span class="hljs-keyword">in</span> labels]<br>        <span class="hljs-comment"># 跟进源码 首先读取预备的tlds之后 关于suffix_index，此处应当是返回之后的顶级域名的位置</span><br>        suffix_index = self._get_tld_extractor().suffix_index(translations)<br>        <span class="hljs-comment"># 将后缀全部获取</span><br>        suffix = <span class="hljs-string">&quot;.&quot;</span>.join(labels[suffix_index:])<br>        <span class="hljs-comment"># 如果后缀不存在 且 域名分割数组存在 且 是ip地址</span><br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> suffix <span class="hljs-keyword">and</span> netloc <span class="hljs-keyword">and</span> utils.looks_like_ip(netloc):<br>            <span class="hljs-keyword">return</span> ExtractResult(<span class="hljs-string">&#x27;&#x27;</span>, netloc, <span class="hljs-string">&#x27;&#x27;</span>)<br><br>        subdomain = <span class="hljs-string">&quot;.&quot;</span>.join(labels[:suffix_index - <span class="hljs-number">1</span>]) <span class="hljs-keyword">if</span> suffix_index <span class="hljs-keyword">else</span> <span class="hljs-string">&quot;&quot;</span><br>        domain = labels[suffix_index - <span class="hljs-number">1</span>] <span class="hljs-keyword">if</span> suffix_index <span class="hljs-keyword">else</span> <span class="hljs-string">&quot;&quot;</span><br>        <span class="hljs-keyword">return</span> ExtractResult(subdomain, domain, suffix)<br>    <br>    <br><span class="hljs-comment"># def _decode_punycode</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">_decode_punycode</span>(<span class="hljs-params">label</span>):</span><br>    <span class="hljs-comment"># 转为小写</span><br>    lowered = label.lower()<br>    <span class="hljs-comment"># 判断是否以xn--开头？总感觉是正则匹配中的内容，但是没有查到，经过查询应该是对于国际化域名(Internationalized Domain Name,IDN)又名特殊字符域名的解析</span><br>    looks_like_puny = lowered.startswith(<span class="hljs-string">&#x27;xn--&#x27;</span>)<br>    <span class="hljs-comment"># 如果是则按照IDa编码</span><br>    <span class="hljs-keyword">if</span> looks_like_puny:<br>        <span class="hljs-keyword">try</span>:<br>            <span class="hljs-keyword">return</span> idna.decode(label.encode(<span class="hljs-string">&#x27;ascii&#x27;</span>)).lower()<br>        <span class="hljs-keyword">except</span> (UnicodeError, IndexError):<br>            <span class="hljs-keyword">pass</span><br>    <span class="hljs-keyword">return</span> lowered<br><br><br><span class="hljs-comment"># def _get_tld_extractor</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">_get_tld_extractor</span>(<span class="hljs-params">self</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    根据本机的信息</span><br><span class="hljs-string">    Get or compute this object&#x27;s TLDExtractor. Looks up the TLDExtractor</span><br><span class="hljs-string">    in roughly the following order, based on the settings passed to</span><br><span class="hljs-string">    __init__:</span><br><span class="hljs-string"></span><br><span class="hljs-string">    1. Memoized on `self`</span><br><span class="hljs-string">    2. Local system cache file</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    <span class="hljs-comment"># pylint: disable=no-else-return</span><br>    <span class="hljs-comment"># 如果存在_extractor返回</span><br>    <span class="hljs-keyword">if</span> self._extractor:<br>        <span class="hljs-keyword">return</span> self._extractor<br>    <span class="hljs-comment"># 没有则读取文件with open(self.cache_file) as cache_file:return json.loads(cache_file.read())返回内容到tlds</span><br>    tlds = self._get_cached_tlds()<br>    <span class="hljs-keyword">if</span> tlds:<br>        <span class="hljs-comment"># 此处应只是经过了__init__部分：包装这个项目的PSL查找的主要算法，冻结tlds的集合，此后不能再添加或删除任何元素</span><br>        self._extractor = _PublicSuffixListTLDExtractor(tlds)<br>        <span class="hljs-keyword">return</span> self._extractor<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-keyword">raise</span> Exception(<span class="hljs-string">&quot;tlds is empty, cannot proceed without tlds.&quot;</span>)<br>        <br><span class="hljs-comment"># def suffix_index</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">suffix_index</span>(<span class="hljs-params">self, lower_spl</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    返回第一个后缀标签的索引。</span><br><span class="hljs-string">    如果未找到后缀，则返回len（spl）</span><br><span class="hljs-string">    Returns the index of the first suffix label.</span><br><span class="hljs-string">    Returns len(spl) if no suffix is found</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    <span class="hljs-comment"># 输入域名的长度</span><br>    length = <span class="hljs-built_in">len</span>(lower_spl)<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(length):<br>        <span class="hljs-comment"># 获取可能的顶级域名！！！！ 按照代码运行的结果是比如放入baidu.com 会输出.b.a.i.d.u...c.o.m 完全无法理解，经过代码调试，输入的应该是数组</span><br>        maybe_tld = <span class="hljs-string">&#x27;.&#x27;</span>.join(lower_spl[i:])<br>        <span class="hljs-comment"># 例外的顶级域名？</span><br>        exception_tld = <span class="hljs-string">&#x27;!&#x27;</span> + maybe_tld<br>        <span class="hljs-comment"># 返回从第几个开始后的为顶级域名</span><br>        <span class="hljs-keyword">if</span> exception_tld <span class="hljs-keyword">in</span> self.tlds:<br>            <span class="hljs-keyword">return</span> i + <span class="hljs-number">1</span><br><br>        <span class="hljs-keyword">if</span> maybe_tld <span class="hljs-keyword">in</span> self.tlds:<br>            <span class="hljs-keyword">return</span> i<br>        <span class="hljs-comment"># 相较于maybe只是最开始为*</span><br>        wildcard_tld = <span class="hljs-string">&#x27;*.&#x27;</span> + <span class="hljs-string">&#x27;.&#x27;</span>.join(lower_spl[i + <span class="hljs-number">1</span>:])<br>        <span class="hljs-keyword">if</span> wildcard_tld <span class="hljs-keyword">in</span> self.tlds:<br>            <span class="hljs-keyword">return</span> i<br>    <span class="hljs-comment"># 应该大多数返回的都是长度，可能有一定的理解错误。错！ 返回具体的顶级域名</span><br>    <span class="hljs-keyword">return</span> length<br></code></pre></div></td></tr></table></figure>

<p>由于之前的部分内容较多切割到下面进行分析</p>
<figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-comment"># class TLDExtract 中的__call__部分</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__call__</span>(<span class="hljs-params">self, url</span>):</span><br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        Takes a string URL and splits it into its subdomain, domain, and</span><br><span class="hljs-string">        suffix (effective TLD, gTLD, ccTLD, etc.) component.</span><br><span class="hljs-string">        获取字符串URL并将其拆分为子域、域和后缀（有效TLD、gTLD、ccTLD等）组件。</span><br><span class="hljs-string">        &gt;&gt;&gt; ext = TLDExtract()</span><br><span class="hljs-string">        &gt;&gt;&gt; ext(&#x27;http://forums.news.cnn.com/&#x27;)</span><br><span class="hljs-string">        ExtractResult(subdomain=&#x27;forums.news&#x27;, domain=&#x27;cnn&#x27;, suffix=&#x27;com&#x27;)</span><br><span class="hljs-string">        &gt;&gt;&gt; ext(&#x27;http://forums.bbc.co.uk/&#x27;)</span><br><span class="hljs-string">        ExtractResult(subdomain=&#x27;forums&#x27;, domain=&#x27;bbc&#x27;, suffix=&#x27;co.uk&#x27;)</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <span class="hljs-comment"># 匹配scheme_chars开头的内容以://结尾的</span><br>        <span class="hljs-comment"># 注：SCHEME_RE = re.compile(r&#x27;^([&#x27; + scheme_chars + &#x27;]+:)?//&#x27;)</span><br>        <span class="hljs-comment"># scheme_chars = (&#x27;abcdefghijklmnopqrstuvwxyz&#x27;&#x27;ABCDEFGHIJKLMNOPQRSTUVWXYZ&#x27;&#x27;0123456789&#x27;&#x27;+-.&#x27;)</span><br>        <span class="hljs-comment"># 首先去除://或://开头的内容 提取第一个/前的部分 提取第一个?前的内容 提取第一个#前的内容 提取@分割后的最后一个 提取第一个:前的部分 去除前后空格</span><br>        netloc = SCHEME_RE.sub(<span class="hljs-string">&quot;&quot;</span>, url) \<br>            .partition(<span class="hljs-string">&quot;/&quot;</span>)[<span class="hljs-number">0</span>] \<br>            .partition(<span class="hljs-string">&quot;?&quot;</span>)[<span class="hljs-number">0</span>] \<br>            .partition(<span class="hljs-string">&quot;#&quot;</span>)[<span class="hljs-number">0</span>] \<br>            .split(<span class="hljs-string">&quot;@&quot;</span>)[-<span class="hljs-number">1</span>] \<br>            .partition(<span class="hljs-string">&quot;:&quot;</span>)[<span class="hljs-number">0</span>] \<br>            .strip() \<br>            .rstrip(<span class="hljs-string">&quot;.&quot;</span>)<br>        <span class="hljs-comment"># 按照.对域名进行分割</span><br>        labels = netloc.split(<span class="hljs-string">&quot;.&quot;</span>)<br>        <span class="hljs-comment"># 跟进源码分析 将域名逐个添加到translations中</span><br>        translations = [_decode_punycode(label) <span class="hljs-keyword">for</span> label <span class="hljs-keyword">in</span> labels]<br>        <span class="hljs-comment"># 跟进源码 首先读取预备的tlds之后 关于suffix_index，此处应当是返回之后的顶级域名的位置</span><br>        suffix_index = self._get_tld_extractor().suffix_index(translations)<br>        <span class="hljs-comment"># 将后缀全部获取</span><br>        suffix = <span class="hljs-string">&quot;.&quot;</span>.join(labels[suffix_index:])<br>        <span class="hljs-comment"># 如果后缀不存在 且 域名分割数组存在 且 是ip地址</span><br>        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> suffix <span class="hljs-keyword">and</span> netloc <span class="hljs-keyword">and</span> utils.looks_like_ip(netloc):<br>            <span class="hljs-comment"># 由于ip地址会在前面报错，且ip地址搜索子域名不太对的样子，以下代码暂时不分析</span><br>            <span class="hljs-keyword">return</span> ExtractResult(<span class="hljs-string">&#x27;&#x27;</span>, netloc, <span class="hljs-string">&#x27;&#x27;</span>)<br>        <span class="hljs-comment"># 返回0-suffix_index的内容，此处应该是一个子域名头部 在有suffix_index的情况下</span><br>        subdomain = <span class="hljs-string">&quot;.&quot;</span>.join(labels[:suffix_index - <span class="hljs-number">1</span>]) <span class="hljs-keyword">if</span> suffix_index <span class="hljs-keyword">else</span> <span class="hljs-string">&quot;&quot;</span><br>        <span class="hljs-comment"># 返回除后缀的前一个 在有suffix_index的情况下</span><br>        domain = labels[suffix_index - <span class="hljs-number">1</span>] <span class="hljs-keyword">if</span> suffix_index <span class="hljs-keyword">else</span> <span class="hljs-string">&quot;&quot;</span><br>        <span class="hljs-comment"># 带着内容进入对象ExtractResult</span><br>        <span class="hljs-keyword">return</span> ExtractResult(subdomain, domain, suffix)<br><br><span class="hljs-comment"># def looks_like_ip</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">looks_like_ip</span>(<span class="hljs-params">maybe_ip</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;Does the given str look like an IP address?&quot;&quot;&quot;</span><br>    <span class="hljs-comment"># 判断数组[0]是否只是由数字组成</span><br>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> maybe_ip[<span class="hljs-number">0</span>].isdigit():<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br>	<span class="hljs-comment"># 发现ip地址会卡死在 get_domains函数步骤，想到子域名收集应当是不用ip地址进行查询的。此处只对以下代码进行分析</span><br>    <span class="hljs-keyword">try</span>:<br>        <span class="hljs-comment"># 判断ip地址是否可以连接</span><br>        socket.inet_aton(maybe_ip)<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span><br>    <span class="hljs-keyword">except</span> (AttributeError, UnicodeError):<br>        <span class="hljs-comment"># 如果不可以连接，用正则表达式进行匹配</span><br>        <span class="hljs-keyword">if</span> IP_RE.match(maybe_ip):<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span><br>    <span class="hljs-keyword">except</span> socket.error:<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span><br><span class="hljs-comment"># class ExtractResult 此处只粘贴了需要使用的</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ExtractResult</span>(<span class="hljs-params">collections.namedtuple(<span class="hljs-params"><span class="hljs-string">&#x27;ExtractResult&#x27;</span>, <span class="hljs-string">&#x27;subdomain domain suffix&#x27;</span></span>)</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;namedtuple of a URL&#x27;s subdomain, domain, and suffix.&quot;&quot;&quot;</span><br><br>    <span class="hljs-comment"># Necessary for __dict__ member to get populated in Python 3+</span><br>    __slots__ = ()<br>    <span class="hljs-comment"># 表示只读，不能修改</span><br><span class="hljs-meta">    @property</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">registered_domain</span>(<span class="hljs-params">self</span>):</span><br>        <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">        Joins the domain and suffix fields with a dot, if they&#x27;re both set.</span><br><span class="hljs-string"></span><br><span class="hljs-string">        &gt;&gt;&gt; extract(&#x27;http://forums.bbc.co.uk&#x27;).registered_domain</span><br><span class="hljs-string">        &#x27;bbc.co.uk&#x27;</span><br><span class="hljs-string">        &gt;&gt;&gt; extract(&#x27;http://localhost:8080&#x27;).registered_domain</span><br><span class="hljs-string">        &#x27;&#x27;</span><br><span class="hljs-string">        &quot;&quot;&quot;</span><br>        <span class="hljs-comment"># 如果有domain和suffix则返回组合 此处返回def registered部分</span><br>        <span class="hljs-keyword">if</span> self.domain <span class="hljs-keyword">and</span> self.suffix:<br>            <span class="hljs-keyword">return</span> self.domain + <span class="hljs-string">&#x27;.&#x27;</span> + self.suffix<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;&#x27;</span><br></code></pre></div></td></tr></table></figure>

<p>终于把这部分分析完了，此处做一个思维导图来汇总一下自己的分析流程</p>
<pre><code class=" mermaid">graph TD
run(run函数)--&gt;|逐个传入domain.eg:www.baidu.com|utils.get_main_domain[utils.get_main_domain]
utils.get_main_domain[utils.get_main_domain]--&gt;|返回需要进行搜索的domain.eg:baidu.com|run(run函数)
utils.get_main_domain[utils.get_main_domain]--&gt;|传入domain.eg:www.baidu.com|Domian.registered(Domian.registered)
Domian.registered(Domian.registered)--&gt;|返回domain.eg:baidu.com|utils.get_main_domain[utils.get_main_domain]
Domian.registered(Domian.registered)--&gt;|传入self:大量信息包含domain,tlds文件路径|extract[extract]
extract[extract]--&gt;|返回object调用的函数registered_domain:domain+suffix.eg:baidu.com|Domian.registered(Domian.registered)
extract(extract)--&gt;|传入suffix_list的路径|tldextract.TLDExtract(tldextract.TLDExtract)
tldextract.TLDExtract(tldextract.TLDExtract)--&gt;|返回标准的路径即/home路径|extract(extract)
extract(extract)--&gt;|传入标准的domain.|tldextract.TLDExtract.__call__(tldextract.TLDExtract.__call__)
tldextract.TLDExtract.__call__(tldextract.TLDExtract.__call__)--&gt;|返回一个包含subdomain:www, domain:baidu, suffix:com的对象|extract(extract)
tldextract.TLDExtract.__call__(tldextract.TLDExtract.__call__)--&gt;|传入self|_get_tld_extractor(_get_tld_extractor)
_get_tld_extractor(_get_tld_extractor)--&gt;|返回被锁定的域名后缀列表|tldextract.TLDExtract.__call__(tldextract.TLDExtract.__call__)
tldextract.TLDExtract.__call__(tldextract.TLDExtract.__call__)--&gt;|传入domain按照.分割后的数组|_get_tld_extractor.suffix_index(_get_tld_extractor.suffix_index)
_get_tld_extractor.suffix_index(_get_tld_extractor.suffix_index)--&gt;|返回找到的后缀索引|tldextract.TLDExtract.__call__(tldextract.TLDExtract.__call__)
tldextract.TLDExtract.__call__(tldextract.TLDExtract.__call__)--&gt;|传入subdomain:www, domain:baidu, suffix:com|ExtractResult(ExtractResult)
ExtractResult(ExtractResult)--&gt;|返回一个object|tldextract.TLDExtract.__call__(tldextract.TLDExtract.__call__)
</code></pre>

<h3 id="5-7-export-all函数"><a href="#5-7-export-all函数" class="headerlink" title="5.7 export_all函数"></a>5.7 export_all函数</h3><p>对于之后的main函数放置到下一部分，将mian函数之后的内容进行分析</p>
<figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-comment"># 如果查询的是多个域名</span><br><span class="hljs-keyword">if</span> count &gt; <span class="hljs-number">1</span>:<br>    <span class="hljs-comment"># 存储内容还不清楚具体各个参数的含义，分析main函数后进一步解析</span><br>    utils.export_all(self.alive, self.fmt, self.path, self.datas)<br></code></pre></div></td></tr></table></figure>

<h4 id="5-7-1-export-all函数"><a href="#5-7-1-export-all函数" class="headerlink" title="5.7.1 export_all函数"></a>5.7.1 export_all函数</h4><p>结果导出函数</p>
<figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">export_all</span>(<span class="hljs-params">alive, fmt, path, datas</span>):</span><br>    <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">    将所有结果数据导出</span><br><span class="hljs-string"></span><br><span class="hljs-string">    :param bool alive: 只导出存活子域结果</span><br><span class="hljs-string">    :param str fmt: 导出文件格式</span><br><span class="hljs-string">    :param str path: 导出文件路径</span><br><span class="hljs-string">    :param list datas: 待导出的结果数据</span><br><span class="hljs-string">    &quot;&quot;&quot;</span><br>    <span class="hljs-comment"># 检查导出的格式是否是json或csv</span><br>    fmt = check_format(fmt)<br>    <span class="hljs-comment"># 获取输出时间</span><br>    timestamp = get_timestring()<br>    <br>    name = <span class="hljs-string">f&#x27;all_subdomain_result_<span class="hljs-subst">&#123;timestamp&#125;</span>&#x27;</span><br>    <span class="hljs-comment"># </span><br>    export_all_results(path, name, fmt, datas)<br>    export_all_subdomains(alive, path, name, datas)<br></code></pre></div></td></tr></table></figure>

<h4 id="5-7-2-export-all-results和export-all-subdomains函数"><a href="#5-7-2-export-all-results和export-all-subdomains函数" class="headerlink" title="5.7.2 export_all_results和export_all_subdomains函数"></a>5.7.2 export_all_results和export_all_subdomains函数</h4><figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-comment"># def export_all_results</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">export_all_results</span>(<span class="hljs-params">path, name, fmt, datas</span>):</span><br>    <span class="hljs-comment"># 检查保存路径的正确 此处不进一步分析</span><br>    path = check_path(path, name, fmt)<br>    logger.log(<span class="hljs-string">&#x27;ALERT&#x27;</span>, <span class="hljs-string">f&#x27;The subdomain result for all main domains: <span class="hljs-subst">&#123;path&#125;</span>&#x27;</span>)<br>    row_list = <span class="hljs-built_in">list</span>()<br>    <span class="hljs-keyword">for</span> row <span class="hljs-keyword">in</span> datas:<br>        <span class="hljs-comment"># 判断是第一行的时候的处理</span><br>        <span class="hljs-keyword">if</span> <span class="hljs-string">&#x27;header&#x27;</span> <span class="hljs-keyword">in</span> row:<br>            row.pop(<span class="hljs-string">&#x27;header&#x27;</span>)<br>        <span class="hljs-keyword">if</span> <span class="hljs-string">&#x27;response&#x27;</span> <span class="hljs-keyword">in</span> row:<br>            row.pop(<span class="hljs-string">&#x27;response&#x27;</span>)<br>        <span class="hljs-comment"># 赋值</span><br>        keys = row.keys()<br>        values = row.values()<br>        <span class="hljs-comment"># 添加到row_list中，此处的class Record的作用是判断两者是否长度匹配</span><br>        row_list.append(Record(keys, values))<br>    <span class="hljs-comment"># 此处初始化了对象</span><br>    rows = RecordCollection(<span class="hljs-built_in">iter</span>(row_list))<br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string">def export(self, format, **kwargs):</span><br><span class="hljs-string">    #Export the RecordCollection to a given format (courtesy of Tablib).</span><br><span class="hljs-string">    将RecordCollection导出为给定格式 Tablib实现</span><br><span class="hljs-string">    return self.dataset.export(format, **kwargs)</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br>    content = rows.export(fmt)<br>    <span class="hljs-comment"># 保存到文件中</span><br>    save_to_file(path, content)<br></code></pre></div></td></tr></table></figure>

<p>export_all_subdomains部分</p>
<figure class="highlight python"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs python"><span class="hljs-comment"># def export_all_subdomains</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">export_all_subdomains</span>(<span class="hljs-params">alive, path, name, datas</span>):</span><br>    <span class="hljs-comment"># 检查路径</span><br>    path = check_path(path, name, <span class="hljs-string">&#x27;txt&#x27;</span>)<br>    logger.log(<span class="hljs-string">&#x27;ALERT&#x27;</span>, <span class="hljs-string">f&#x27;The txt subdomain result for all main domains: <span class="hljs-subst">&#123;path&#125;</span>&#x27;</span>)<br>    subdomains = <span class="hljs-built_in">set</span>()<br>    <span class="hljs-comment"># 逐个读取内容</span><br>    <span class="hljs-keyword">for</span> row <span class="hljs-keyword">in</span> datas:<br>        subdomain = row.get(<span class="hljs-string">&#x27;subdomain&#x27;</span>)<br>        <span class="hljs-comment"># 如果alive存在</span><br>        <span class="hljs-keyword">if</span> alive:<br>            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> row.get(<span class="hljs-string">&#x27;alive&#x27;</span>):<br>                <span class="hljs-keyword">continue</span><br>            subdomains.add(subdomain)<br>        <span class="hljs-keyword">else</span>:<br>            subdomains.add(subdomain)<br>    data = <span class="hljs-string">&#x27;\n&#x27;</span>.join(subdomains)<br>    <span class="hljs-comment"># 保存文件</span><br>    save_to_file(path, data)<br></code></pre></div></td></tr></table></figure>


            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                  <div class="post-meta mr-3">
                    <i class="iconfont icon-category"></i>
                    
                      <a class="hover-with-bg" href="/categories/%E4%BF%A1%E5%AE%89-%E5%B7%A5%E5%85%B7%E5%88%86%E6%9E%90-OneForAll/">信安 工具分析 OneForAll</a>
                    
                  </div>
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/tags/python/">python</a>
                    
                      <a class="hover-with-bg" href="/tags/%E5%B7%A5%E5%85%B7%E5%88%86%E6%9E%90/">工具分析</a>
                    
                      <a class="hover-with-bg" href="/tags/OneForAll/">OneForAll</a>
                    
                  </div>
                
              </div>
              
              
            </div>

            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    

    
      <a id="scroll-top-button" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     <i class="iconfont icon-love"></i> <a href="/" target="_blank" rel="nofollow noopener"><span>MyBlog</span></a> 
  </div>
  

  

  
</footer>


  <!-- SCRIPTS -->
  
  <script  src="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" ></script>
<script  src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>

<!-- Plugins -->


  
    <script  src="/js/img-lazyload.js" ></script>
  



  



  <script  src="https://cdn.jsdelivr.net/npm/tocbot@4.12.3/dist/tocbot.min.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/anchor-js@4.3.1/anchor.min.js" ></script>



  <script defer src="https://cdn.jsdelivr.net/npm/clipboard@2.0.8/dist/clipboard.min.js" ></script>



  <script  src="/js/local-search.js" ></script>






  <script  src="https://cdn.jsdelivr.net/npm/typed.js@2.0.12/lib/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var title = document.getElementById('subtitle').title;
      
      typing(title)
      
    })(window, document);
  </script>















<!-- 主题的启动项 保持在最底部 -->
<script  src="/js/boot.js" ></script>


</body>
</html>
